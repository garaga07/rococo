name: e2e

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  api-tests:
    runs-on: ubuntu-latest
    env:
      PROFILE: docker
      COMPOSE_PROFILES: test
      PREFIX: garaga7
      ARCH: amd64
      ALLURE_DOCKER_API: ${{ secrets.ALLURE_DOCKER_API }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      BUILD_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      EXECUTION_TYPE: github
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ env.GITHUB_SHA }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build backends
        run: |
          ./gradlew jibDockerBuild -x :rococo-tests:test

      - name: Start required services
        run: docker compose up -d rococo-all-db kafka zookeeper auth.rococo.dc gateway.rococo.dc artist.rococo.dc

      - name: Run API Tests (Artist)
        id: api-tests
        continue-on-error: true  # Ð¢ÐµÑÑ‚Ñ‹ Ð½Ðµ Ð±ÑƒÐ´ÑƒÑ‚ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸
        run: |
          docker run --rm ${PREFIX}/rococo-tests ./gradlew testArtistApi -Dtest.env=docker
          exit_code=$?
          echo "API_EXIT_CODE=$exit_code" >> $GITHUB_ENV
          exit $exit_code

      - name: Add comment to PR with link to allure
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const exitCode = ${{ env.API_EXIT_CODE }}
            const reportUrl = 'https://allure.niffler-stage.qa.guru/api/allure-docker-service/projects/rococo-garaga/reports/latest/index.html'
            const historyUrl = 'https://allure.niffler-stage.qa.guru/allure-docker-service-ui/projects/rococo-garaga'
            const message = exitCode == '0' ?
              `âœ… API TESTS PASSED âœ… There is the [report](${reportUrl})\nðŸ•“ All reports [history](${historyUrl})` :
              `ðŸ”´ API TESTS FAILED ðŸ”´ There is the [report](${reportUrl})\nðŸ•“ All reports [history](${historyUrl})`
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })

  web-tests:
    runs-on: ubuntu-latest
    env:
      PROFILE: docker
      COMPOSE_PROFILES: test
      PREFIX: garaga7
      ARCH: amd64
      ALLURE_DOCKER_API: ${{ secrets.ALLURE_DOCKER_API }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      BUILD_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      EXECUTION_TYPE: github
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ env.GITHUB_SHA }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build backends
        run: |
          ./gradlew jibDockerBuild -x :rococo-tests:test

      - name: Start required services
        run: docker compose up -d frontend.rococo.dc selenoid selenoid-ui

      - name: Run Web Tests (Artist)
        id: web-tests
        continue-on-error: true  # Ð¢ÐµÑÑ‚Ñ‹ Ð½Ðµ Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÑŽÑ‚ API Ñ‚ÐµÑÑ‚Ñ‹
        run: |
          docker run --rm ${PREFIX}/rococo-tests ./gradlew testArtistWeb -Dtest.env=docker
          exit_code=$?
          echo "WEB_EXIT_CODE=$exit_code" >> $GITHUB_ENV
          exit $exit_code

      - name: Add comment to PR with link to allure
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const exitCode = ${{ env.WEB_EXIT_CODE }}
            const reportUrl = 'https://allure.niffler-stage.qa.guru/api/allure-docker-service/projects/rococo-garaga/reports/latest/index.html'
            const historyUrl = 'https://allure.niffler-stage.qa.guru/allure-docker-service-ui/projects/rococo-garaga'
            const message = exitCode == '0' ?
              `âœ… WEB TESTS PASSED âœ… There is the [report](${reportUrl})\nðŸ•“ All reports [history](${historyUrl})` :
              `ðŸ”´ WEB TESTS FAILED ðŸ”´ There is the [report](${reportUrl})\nðŸ•“ All reports [history](${historyUrl})`
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })